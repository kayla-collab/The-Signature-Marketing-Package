<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restore Anand & Your Modules</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .form-group {
            margin: 20px 0;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background: #5568d3;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid #0dcaf0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        #log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Restore Your Client & Modules</h1>

        <div class="info">
            <strong>‚ÑπÔ∏è What This Does:</strong><br>
            Restores Anand and recreates your YouTube Execution and Welcome modules
        </div>

        <div class="section">
            <h2>Step 1: Restore Anand</h2>
            <div class="form-group">
                <label>Client Name</label>
                <input type="text" id="clientName" value="Anand" placeholder="Client name">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="clientEmail" value="anand@client.com" placeholder="client@email.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="text" id="clientPassword" value="anand123" placeholder="password">
            </div>
            <button onclick="restoreClient()">‚úÖ Restore Anand</button>
        </div>

        <div class="section">
            <h2>Step 2: Restore Your Modules</h2>
            <div class="info">
                <strong>Modules to restore:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>YouTube Execution</li>
                    <li>Welcome Module</li>
                </ul>
            </div>
            <button onclick="restoreModules()">‚úÖ Restore YouTube Execution & Welcome Modules</button>
        </div>

        <div class="section">
            <h2>Step 3: Delete Demo Data (Optional)</h2>
            <div class="info">
                <strong>‚ö†Ô∏è This will delete:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>Demo Client (demo@client.com)</li>
                    <li>All 5 demo modules (Long-Game Engine, Brand Strategy, etc.)</li>
                    <li>All demo content items</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Your real data will NOT be affected!</strong></p>
            </div>
            <button class="danger" onclick="deleteDemoData()">üóëÔ∏è Delete All Demo Data</button>
        </div>

        <div id="log"></div>

        <div id="successBox" style="display: none;" class="success">
            <h3>‚úÖ Restoration Complete!</h3>
            <p style="margin-top: 10px;"><strong>What was restored:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>‚úÖ Client: Anand</li>
                <li>‚úÖ YouTube Execution module</li>
                <li>‚úÖ Welcome module</li>
            </ul>
            <p style="margin-top: 15px;"><strong>Next steps:</strong></p>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li>Go to <a href="admin.html">Admin Panel</a></li>
                <li>Check "Manage Clients" - Anand should be there</li>
                <li>Check "Manage Modules" - Your modules should be there</li>
                <li>Use Module Builder to add content back to your modules</li>
            </ol>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const colorClass = `log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function restoreClient() {
            log('üîß Restoring client...', 'info');
            
            const name = document.getElementById('clientName').value;
            const email = document.getElementById('clientEmail').value;
            const password = document.getElementById('clientPassword').value;

            if (!name || !email || !password) {
                alert('Please fill in all fields!');
                return;
            }

            try {
                // Check if client already exists
                const checkResponse = await fetch('tables/users?limit=1000');
                const existingData = await checkResponse.json();
                const existing = existingData.data.find(u => u.email === email);

                if (existing) {
                    log(`‚ö†Ô∏è Client with email ${email} already exists!`, 'warning');
                    alert(`Client ${email} already exists. No need to restore.`);
                    return;
                }

                // Create client
                const clientData = {
                    email: email,
                    password_hash: password,
                    full_name: name,
                    role: 'client',
                    is_active: true,
                    access_expires: null
                };

                const response = await fetch('tables/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientData)
                });

                if (!response.ok) {
                    throw new Error(`Failed to create client: ${response.status}`);
                }

                const client = await response.json();
                log(`‚úÖ Client restored: ${name} (${email})`, 'success');
                log(`   Login: ${email} / ${password}`, 'info');
                
                alert(`‚úÖ ${name} restored successfully!\n\nLogin: ${email}\nPassword: ${password}`);

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                alert('Error restoring client: ' + error.message);
            }
        }

        async function restoreModules() {
            log('üîß Restoring modules...', 'info');

            try {
                const modules = [
                    {
                        title: 'YouTube Execution',
                        description: '<p><strong>YouTube Content Execution Strategy</strong></p><p>Your comprehensive guide to executing successful YouTube content. This module covers everything from planning to publishing and optimization.</p>',
                        order_index: 1,
                        icon: 'üé¨'
                    },
                    {
                        title: 'Welcome',
                        description: '<p><strong>Welcome to Your Training Platform!</strong></p><p>Start here to get familiar with the platform and understand how to make the most of your training modules.</p>',
                        order_index: 2,
                        icon: 'üëã'
                    }
                ];

                for (const moduleData of modules) {
                    // Check if module already exists
                    const checkResponse = await fetch('tables/modules?limit=1000');
                    const existingData = await checkResponse.json();
                    const existing = existingData.data.find(m => 
                        (m.title === moduleData.title || m.module_name === moduleData.title)
                    );

                    if (existing) {
                        log(`‚ö†Ô∏è Module "${moduleData.title}" already exists, skipping`, 'warning');
                        continue;
                    }

                    const response = await fetch('tables/modules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(moduleData)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to create module: ${response.status}`);
                    }

                    const module = await response.json();
                    log(`‚úÖ Module restored: ${moduleData.title}`, 'success');
                }

                alert('‚úÖ Modules restored!\n\n- YouTube Execution\n- Welcome\n\nGo to Module Builder to add content to them.');
                document.getElementById('successBox').style.display = 'block';

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                alert('Error restoring modules: ' + error.message);
            }
        }

        async function deleteDemoData() {
            if (!confirm('‚ö†Ô∏è Delete ALL demo data?\n\nThis will remove:\n- Demo client\n- 5 demo modules\n- All demo content\n\nYour real clients (Anand, etc.) will NOT be affected!\n\nContinue?')) {
                return;
            }

            log('üóëÔ∏è Deleting demo data...', 'info');

            try {
                // Get all data
                const usersResponse = await fetch('tables/users?limit=1000');
                const usersData = await usersResponse.json();
                
                const modulesResponse = await fetch('tables/modules?limit=1000');
                const modulesData = await modulesResponse.json();
                
                const contentResponse = await fetch('tables/content_items?limit=1000');
                const contentData = await contentResponse.json();

                // Delete demo client
                const demoClient = usersData.data.find(u => u.email === 'demo@client.com');
                if (demoClient) {
                    await fetch(`tables/users/${demoClient.id}`, { method: 'DELETE' });
                    log('‚úÖ Deleted demo client', 'success');
                }

                // Delete demo modules (the 5 created by demo script)
                const demoModuleNames = [
                    'The Long-Game Engine',
                    'Brand Strategy Blueprint',
                    'Social Media Mastery',
                    'Email Marketing System',
                    'Client Onboarding'
                ];

                for (const moduleName of demoModuleNames) {
                    const module = modulesData.data.find(m => 
                        m.title === moduleName || m.module_name === moduleName
                    );
                    if (module) {
                        // Delete content for this module
                        const moduleContent = contentData.data.filter(c => c.module_id === module.id);
                        for (const content of moduleContent) {
                            await fetch(`tables/content_items/${content.id}`, { method: 'DELETE' });
                        }
                        
                        // Delete module
                        await fetch(`tables/modules/${module.id}`, { method: 'DELETE' });
                        log(`‚úÖ Deleted demo module: ${moduleName}`, 'success');
                    }
                }

                // Delete demo client assignments
                const cmResponse = await fetch('tables/client_modules?limit=1000');
                const cmData = await cmResponse.json();
                if (demoClient) {
                    const demoAssignments = cmData.data.filter(cm => cm.client_id === demoClient.id);
                    for (const assignment of demoAssignments) {
                        await fetch(`tables/client_modules/${assignment.id}`, { method: 'DELETE' });
                    }
                }

                // Delete demo greetings
                const greetingsResponse = await fetch('tables/client_greetings?limit=1000');
                const greetingsData = await greetingsResponse.json();
                if (demoClient) {
                    const demoGreetings = greetingsData.data.filter(g => g.client_id === demoClient.id);
                    for (const greeting of demoGreetings) {
                        await fetch(`tables/client_greetings/${greeting.id}`, { method: 'DELETE' });
                    }
                }

                log('‚úÖ Demo data deleted successfully!', 'success');
                alert('‚úÖ All demo data deleted!\n\nYour real clients and modules are safe.\n\nRefresh the admin panel to see the clean state.');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                alert('Error deleting demo data: ' + error.message);
            }
        }
    </script>
</body>
</html>